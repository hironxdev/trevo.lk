generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  INDIVIDUAL_PARTNER
  BUSINESS_PARTNER
  ADMIN
}

enum KYCStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VehicleStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  INACTIVE
}

enum VehicleCategory {
  BUDGET_DAILY
  LUXURY
  MID_RANGE
  TOURISM
  TRAVEL
  BUSINESS
}

enum BookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
  REJECTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PartnerType {
  INDIVIDUAL
  BUSINESS
}

enum VehicleType {
  CAR
  VAN
  SUV
  BIKE
  BUS
  TRUCK
  OTHER
}

enum RentalType {
  LONG_TERM
  SHORT_TERM
}

enum ServiceType {
  VEHICLE_RENTAL
  STAYS
  BOTH
}

enum StaysType {
  HOUSE
  APARTMENT
  VILLA
  HOTEL
  GUEST_HOUSE
  BUNGALOW
  ROOM
  OTHER
}

enum StaysCategoryType {
  BUDGET
  STANDARD
  LUXURY
  PREMIUM
  BEACHFRONT
  HILL_COUNTRY
  CITY_CENTER
  RURAL
}

enum StaysBookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
  REJECTED
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String    @unique
  phone         String?   @unique
  emailVerified DateTime?
  phoneVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  bookings      Booking[]
  reviews       Review[]
  notifications Notification[]
  partner       Partner?
  adminLogs     AdminLog[]
  staysBookings StaysBooking[]
  staysReviews  StaysReview[]
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Partner {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  userId      String      @unique @db.ObjectId
  partnerType PartnerType

  serviceType ServiceType @default(VEHICLE_RENTAL)

  // Common fields
  kycStatus       KYCStatus @default(PENDING)
  bankDetails     Json?
  documents       Json?
  verifiedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Individual Partner fields
  fullName             String?
  nicNumber            String? // NIC/Passport
  dateOfBirth          DateTime?
  gender               String?
  whatsappNumber       String?
  residentialAddress   String?
  drivingLicenseNumber String?
  drivingLicenseExpiry DateTime?

  // Business Partner fields
  businessName                String?
  businessRegNumber           String?
  businessRegDate             DateTime?
  businessType                String? // Sole Proprietor, Partnership, Pvt Ltd, PLC
  vatNumber                   String?
  authorizedPersonName        String?
  authorizedPersonNic         String?
  authorizedPersonDesignation String?
  businessAddress             String?
  businessHotline             String?
  businessEmail               String?
  totalVehicles               Int?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicles Vehicle[]
  bookings Booking[]
  stays         Stays[]
  staysBookings StaysBooking[]
}

model Category {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  name        String          @unique
  description String
  icon        String?
  slug        String          @unique
  category    VehicleCategory
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  vehicles Vehicle[]
}

model Vehicle {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  partnerId        String?       @db.ObjectId
  categoryId       String?       @db.ObjectId
  make             String?
  model            String?
  year             Int?
  color            String?
  licensePlate     String?       @unique
  vehicleType      VehicleType?
  features         Json?
  specifications   Json?
  status           VehicleStatus @default(AVAILABLE)
  pricePerDay      Float?
  pricePerKm       Float?
  monthlyPrice     Float?
  depositRequired  Float?
  unlimitedMileage Boolean       @default(false)
  withDriver       Boolean?      @default(false)
  location         String?
  images           String[]
  availableFrom    DateTime?
  availableUntil   DateTime?
  isApproved       Boolean       @default(false)
  approvedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  rentalType          RentalType? @default(SHORT_TERM)
  driverPricePerDay   Float?
  driverPricePerKm    Float?
  driverPricePerMonth Float?
  includedKmPerDay    Int?
  includedKmPerMonth  Int?

  isAdminCreated  Boolean @default(false)
  contactOnly     Boolean @default(false)
  adminNotes      String?

  externalPartnerName     String?
  externalPartnerPhone    String?
  externalPartnerEmail    String?
  externalPartnerWhatsApp String?
  externalPartnerAddress  String?
  externalPartnerType     String?

  displayName String?

  partner  Partner?  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id])
  bookings Booking[]
  reviews  Review[]
}

model Booking {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  vehicleId       String        @db.ObjectId
  userId          String        @db.ObjectId
  partnerId       String        @db.ObjectId
  startDate       DateTime
  endDate         DateTime
  totalDays       Int
  pricing         Json
  status          BookingStatus @default(PENDING)
  pickupLocation  String
  dropoffLocation String?
  depositPaid     Float
  depositRefunded Boolean       @default(false)
  notes           String?
  cancelReason    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  withDriver            Boolean?    @default(false)
  rentalType            RentalType? @default(SHORT_TERM)
  partnerConfirmed      Boolean     @default(false)
  includedKm            Int?
  extraKmUsed           Int?
  actualDropoffLocation String?
  totalMonths           Int?

  vehicle  Vehicle   @relation(fields: [vehicleId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])
  partner  Partner   @relation(fields: [partnerId], references: [id])
  payments Payment[]
  review   Review?
}

model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingId     String        @db.ObjectId
  amount        Float
  method        String
  status        PaymentStatus @default(PENDING)
  transactionId String?
  metadata      Json?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])
}

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String   @unique @db.ObjectId
  vehicleId  String   @db.ObjectId
  userId     String   @db.ObjectId
  rating     Int
  comment    String?
  response   String?
  isApproved Boolean  @default(true)
  isFlagged  Boolean  @default(false)
  flagReason String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  type      String
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AdminLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  adminId   String   @db.ObjectId
  action    String
  target    String
  targetId  String?
  details   Json?
  createdAt DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id])
}


model StaysCategory {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  name        String            @unique
  description String
  icon        String?
  slug        String            @unique
  category    StaysCategoryType
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  stays Stays[]
}

model Stays {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  partnerId  String? @db.ObjectId
  categoryId String? @db.ObjectId

  // Basic Info
  name        String
  description String?
  staysType   StaysType

  // Location
  address     String
  city        String
  district    String?
  location    String? // General area description
  coordinates Json? // { lat, lng }

  // Capacity & Rooms
  bedrooms  Int
  bathrooms Int
  maxGuests Int
  beds      Int?

  // Amenities & Features
  amenities  String[] // WiFi, AC, Pool, Kitchen, etc.
  houseRules String[]
  features   Json?

  // Pricing
  pricePerNight   Float?
  pricePerWeek    Float?
  pricePerMonth   Float?
  cleaningFee     Float?
  depositRequired Float?

  // Availability
  status         VehicleStatus @default(AVAILABLE) // Reuse existing enum
  availableFrom  DateTime?
  availableUntil DateTime?
  minNights      Int?          @default(1)
  maxNights      Int?

  // Media
  images String[]

  // Admin/Approval
  isApproved      Boolean   @default(false)
  approvedAt      DateTime?
  rejectionReason String?
  isAdminCreated  Boolean   @default(false)
  contactOnly     Boolean   @default(false)
  adminNotes      String?

  // External Partner (for admin-created listings)
  externalPartnerName     String?
  externalPartnerPhone    String?
  externalPartnerEmail    String?
  externalPartnerWhatsApp String?
  externalPartnerAddress  String?
  externalPartnerType     String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  partner       Partner?       @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  staysCategory StaysCategory? @relation(fields: [categoryId], references: [id])
  bookings      StaysBooking[]
  reviews       StaysReview[]
}

model StaysBooking {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  staysId   String @db.ObjectId
  userId    String @db.ObjectId
  partnerId String @db.ObjectId

  checkIn     DateTime
  checkOut    DateTime
  totalNights Int
  guests      Int

  pricing Json // { pricePerNight, nights, cleaningFee, deposit, subtotal, total }
  status  StaysBookingStatus @default(PENDING)

  depositPaid     Float
  depositRefunded Boolean @default(false)

  specialRequests String?
  cancelReason    String?

  partnerConfirmed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stays    Stays          @relation(fields: [staysId], references: [id])
  user     User?          @relation(fields: [userId], references: [id])
  partner  Partner        @relation(fields: [partnerId], references: [id])
  payments StaysPayment[]
  review   StaysReview?
}

model StaysPayment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  bookingId     String        @db.ObjectId
  amount        Float
  method        String
  status        PaymentStatus @default(PENDING)
  transactionId String?
  metadata      Json?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  booking StaysBooking @relation(fields: [bookingId], references: [id])
}

model StaysReview {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String   @unique @db.ObjectId
  staysId    String   @db.ObjectId
  userId     String   @db.ObjectId
  rating     Int
  comment    String?
  response   String?
  isApproved Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  booking StaysBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  stays   Stays        @relation(fields: [staysId], references: [id])
  user    User         @relation(fields: [userId], references: [id])
}
